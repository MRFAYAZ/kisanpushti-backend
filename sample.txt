# DISABLE ALL COLAB DEBUGGER NOISE
import sys
import os
os.environ['COLAB_DISABLE_DEBUGPY'] = '1'


import warnings
warnings.filterwarnings('ignore')


import logging
for logger_name in logging.root.manager.loggerDict:
Â  Â  logging.getLogger(logger_name).setLevel(logging.CRITICAL)
logging.getLogger('tensorflow').setLevel(logging.ERROR)


# ============================================
# COLAB BACKEND
# ============================================


from flask import Flask, request, jsonify
from flask_cors import CORS
import tensorflow as tf
from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing import image
import numpy as np
import base64
from io import BytesIO
from PIL import Image
import google.generativeai as genai
import json
from datetime import datetime
from google.colab import userdata
from pyngrok import ngrok


ngrok.set_auth_token("35F22Uxoi6Lvb0WUgrbO24SMGoD_48Xgamu7P14jGqzZq6oTq")


app = Flask(__name__)
CORS(app)


# Gemini
try:
Â  Â  GEMINI_API_KEY = userdata.get('GOOGLE_API_KEY')
Â  Â  genai.configure(api_key=GEMINI_API_KEY)
Â  Â  print("âœ… Gemini API configured!")
except:
Â  Â  GEMINI_API_KEY = None


# Load Model
try:
Â  Â  MODEL = load_model('model_final.h5')
Â  Â  print("âœ… Model loaded!")
Â  Â  print(f" Â  Input shape: {MODEL.input_shape}")
Â  Â  print(f" Â  Output shape: {MODEL.output_shape}")


Â  Â  # Get the correct image size from model input shape
Â  Â  # Format: (None, height, width, channels)
Â  Â # After loading your model:
Â  Â  MODEL_HEIGHT = int(MODEL.input_shape[1]) Â # for (None, 224, 224, 3)
Â  Â  MODEL_WIDTH = int(MODEL.input_shape[2])
Â  Â  print(f"Using image size: ({MODEL_WIDTH}, {MODEL_HEIGHT})")


except Exception as e:
Â  Â  print(f"âŒ Model error: {e}")
Â  Â  MODEL = None
Â  Â  MODEL_HEIGHT = 224
Â  Â  MODEL_WIDTH = 224


DISEASE_CLASSES = [
Â  Â  "Apple___Apple_scab", "Apple___Black_rot", "Apple___Cedar_apple_rust", "Apple___healthy",
Â  Â  "Blueberry___healthy", "Cherry_(including_sour)___Powdery_mildew", "Cherry_(including_sour)___healthy",
Â  Â  "Corn_(maize)___Cercospora_leaf_spot Gray_leaf_spot", "Corn_(maize)___Common_rust_",
Â  Â  "Corn_(maize)___Northern_Leaf_Blight", "Corn_(maize)___healthy", "Grape___Black_rot",
Â  Â  "Grape___Esca_(Black_Measles)", "Grape___Leaf_blight_(Isariopsis_Leaf_Spot)", "Grape___healthy",
Â  Â  "Orange___Haunglongbing_(Citrus_greening)", "Peach___Bacterial_spot", "Peach___healthy",
Â  Â  "Pepper,_bell___Bacterial_spot", "Pepper,_bell___healthy", "Potato___Early_blight",
Â  Â  "Potato___Late_blight", "Potato___healthy", "Raspberry___healthy", "Soybean___healthy",
Â  Â  "Squash___Powdery_mildew", "Strawberry___Leaf_scorch", "Strawberry___healthy",
Â  Â  "Tomato___Bacterial_spot", "Tomato___Early_blight", "Tomato___Late_blight",
Â  Â  "Tomato___Leaf_Mold", "Tomato___Septoria_leaf_spot", "Tomato___Spider_mites Two-spotted_spider_mite",
Â  Â  "Tomato___Target_Spot", "Tomato___Tomato_Yellow_Leaf_Curl_Virus", "Tomato___Tomato_mosaic_virus", "Tomato___healthy"
]


NATIONAL_FARMER_PROBLEM_SOLVER_PROMPT = """
You are Dr. Krishnan, a Senior Agricultural Scientist certified by ICAR (Indian Council of Agricultural Research) with 25+ years of field experience across all Indian states and districts.
Your mission: Generate a COMPLETE, ACTIONABLE disease report that solves the farmer's problem with ZERO ambiguity, in their native language.


=== RULES ===
1. Generate EVERYTHING in FARMER_LANG (no English text except scientific names)
2. Use ONLY ICAR-approved, field-tested remedies (never just general advice)
3. Include a working YouTube tutorial link for each remedy
4. Include a Google Maps search link for nearby agricultural shops selling the materials
5. Calculate treatment ROI for the farmer, compare costs and savings
6. List government schemes & insurance (PMFBY, PKVY, etc.) available in DISTRICT
7. Include traditional organic options (neem, panchgavya, garlic paste), as well as modern treatments
8. All instructions simple enough for a 5th-grade-educated farmer


=== INPUTS ===
- Disease: DISEASE_CLASS
- Crop: CROP_NAME
- Confidence: CONFIDENCE_PERCENT%
- Farmer's Language: FARMER_LANG
- Location: DISTRICT, STATE
- Date: TODAY_DATE
- Season: CURRENT_SEASON


=== OUTPUT JSON STRUCTURE ===
{
Â  "report_metadata": {
Â  Â  "report_id": "ICAR_DISEASE_TIMESTAMP",
Â  Â  "generated_date": "TODAY_DATE",
Â  Â  "farmer_language": "FARMER_LANG",
Â  Â  "location": {
Â  Â  Â  "district": "DISTRICT",
Â  Â  Â  "state": "STATE"
Â  Â  },
Â  Â  "certification": "ICAR-Certified AI Diagnosis Report",
Â  Â  "validity_days": 90,
Â  Â  "model_confidence": CONFIDENCE_PERCENT
Â  },
Â  "disease_diagnosis": {
Â  Â  "disease_name_local": "Name of disease in FARMER_LANG",
Â  Â  "disease_name_english": "English disease name",
Â  Â  "disease_name_scientific": "Binomial name",
Â  Â  "crop_affected": "CROP_NAME in FARMER_LANG",
Â  Â  "causal_agent": "FUNGAL/BACTERIAL/VIRAL/NEMATODE - in FARMER_LANG",
Â  Â  "identification_confidence": "HIGH",
Â  Â  "common_names_in_region": ["Local name 1", "Local name 2"]
Â  },
Â  "why_this_disease_appeared": {
Â  Â  "primary_reason_local": "2-3 lines in FARMER_LANG why disease struck, with region- and season-specific factors.",
Â  Â  "weather_conditions": {
Â  Â  Â  "temperature_range": "Â°C",
Â  Â  Â  "humidity_level": "High/Medium/Low",
Â  Â  Â  "rainfall_pattern": "In FARMER_LANG"
Â  Â  },
Â  Â  "bad_practices": ["Example practice 1 in FARMER_LANG", "Example practice 2"]
Â  },
Â  "severity_assessment": {
Â  Â  "current_stage": "EARLY/MODERATE/SEVERE",
Â  Â  "percentage_crop_affected": "15",
Â  Â  "visual_symptoms": ["Symptom 1", "Symptom 2"],
Â  Â  "spread_rate": "SLOW/MODERATE/FAST",
Â  Â  "days_until_major_loss": "7",
Â  Â  "urgent_action_needed": "YES/NO"
Â  },
Â  "economic_impact_analysis": {
Â  Â  "potential_loss_if_untreated": {
Â  Â  Â  "amount_rupees": "â‚¹150000",
Â  Â  Â  "loss_percentage": "25",
Â  Â  Â  "timeline_days": 7,
Â  Â  Â  "explanation_local": "Explanation in FARMER_LANG"
Â  Â  },
Â  Â  "treatment_cost_vs_savings": {
Â  Â  Â  "cheapest_treatment_cost": "â‚¹300",
Â  Â  Â  "moderate_treatment_cost": "â‚¹800",
Â  Â  Â  "premium_treatment_cost": "â‚¹2000",
Â  Â  Â  "savings_if_treated_early": "â‚¹149700"
Â  Â  }
Â  },
Â  "remedy_recommendations": [
Â  Â  {
Â  Â  Â  "rank": 1,
Â  Â  Â  "remedy_name_local": "Name in FARMER_LANG",
Â  Â  Â  "remedy_type": "TRADITIONAL_ORGANIC",
Â  Â  Â  "icar_approved": true,
Â  Â  Â  "total_cost_rupees": 300,
Â  Â  Â  "step_by_step_application": [
Â  Â  Â  Â  "Step 1 in FARMER_LANG",
Â  Â  Â  Â  "Step 2..."
Â  Â  Â  ],
Â  Â  Â  "youtube_tutorial": "https://youtube.com/results?search_query=REMEDY_NAME+in+FARMER_LANG",
Â  Â  Â  "maps_search_link": "https://www.google.com/maps/search/pesticide+shop+near+DISTRICT+STATE",
Â  Â  Â  "roi_percent": 49900
Â  Â  },
Â  Â  {
Â  Â  Â  "rank": 2,
Â  Â  Â  "remedy_name_local": "Name in FARMER_LANG",
Â  Â  Â  "remedy_type": "MODERN_ORGANIC",
Â  Â  Â  "icar_approved": true,
Â  Â  Â  "total_cost_rupees": 600,
Â  Â  Â  "youtube_tutorial": "https://youtube.com/results?search_query=REMEDY_NAME+in+FARMER_LANG",
Â  Â  Â  "maps_search_link": "https://www.google.com/maps/search/pesticide+shop+near+DISTRICT+STATE",
Â  Â  Â  "roi_percent": 24500
Â  Â  },
Â  Â  {
Â  Â  Â  "rank": 3,
Â  Â  Â  "remedy_name_local": "Name in FARMER_LANG",
Â  Â  Â  "remedy_type": "CHEMICAL",
Â  Â  Â  "icar_approved": true,
Â  Â  Â  "total_cost_rupees": 1200,
Â  Â  Â  "youtube_tutorial": "https://youtube.com/results?search_query=REMEDY_NAME+in+FARMER_LANG",
Â  Â  Â  "maps_search_link": "https://www.google.com/maps/search/pesticide+shop+near+DISTRICT+STATE",
Â  Â  Â  "roi_percent": 12500
Â  Â  }
Â  ],
Â  "government_schemes": [
Â  Â  {
Â  Â  Â  "scheme_name": "Pradhan Mantri Fasal Bima Yojana (PMFBY)",
Â  Â  Â  "in_local_language": "Name in FARMER_LANG",
Â  Â  Â  "eligible": "YES/NO",
Â  Â  Â  "how_to_apply": "Application steps in FARMER_LANG",
Â  Â  Â  "benefit_amount": "90% insured sum",
Â  Â  Â  "helpline": "18001801551"
Â  Â  }
Â  Â  // ... add more schemes as needed ...
Â  ],
Â  "nearby_resources": {
Â  Â  "agricultural_shops_map_link": "https://www.google.com/maps/search/agricultural+pesticide+shop+near+DISTRICT+STATE"
Â  },
Â  "ai_disclaimer": {
Â  Â  "message_local": "This is AI-powered diagnosis. For confirmation, visit KVK (message in FARMER_LANG)"
Â  }
}


=== LANGUAGE EXAMPLES ===
- Remedies, steps, and all instructions should be 100% in FARMER_LANG for Hindi/Tamil/etc.
- YouTube links: "https://youtube.com/results?search_query=neem+spray+application+in+FARMER_LANG"
- Maps links: "https://www.google.com/maps/search/agricultural+pesticide+shop+near+DISTRICT+STATE"


DISEASE: DISEASE_CLASS
CROP: CROP_NAME
CONFIDENCE: CONFIDENCE_PERCENT%
LANGUAGE: FARMER_LANG
DISTRICT: DISTRICT
STATE: STATE
SEASON: CURRENT_SEASON
DATE: TODAY_DATE


Generate only valid JSON. Do not return any markdown or explanation.
"""


def generate_gemini_report(disease_class, confidence, district, state, language='en'):
Â  Â  from datetime import datetime
Â  Â  try:
Â  Â  Â  Â  # Safe string conversion
Â  Â  Â  Â  if isinstance(disease_class, list):
Â  Â  Â  Â  Â  Â  disease_class = str(disease_class[0]) if disease_class else "Unknown"
Â  Â  Â  Â  disease_class = str(disease_class).strip()
Â  Â  Â  Â  if '___' in disease_class:
Â  Â  Â  Â  Â  Â  parts = disease_class.split('___')
Â  Â  Â  Â  Â  Â  crop_name = parts[0].strip()
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  crop_name = "Crop"


Â  Â  Â  Â  # Get season
Â  Â  Â  Â  month = datetime.now().month
Â  Â  Â  Â  if month in [6, 7, 8, 9]:
Â  Â  Â  Â  Â  Â  season = "Kharif"
Â  Â  Â  Â  elif month in [10, 11, 12, 1]:
Â  Â  Â  Â  Â  Â  season = "Rabi"
Â  Â  Â  Â  else:
Â  Â  Â  Â  Â  Â  season = "Summer"


Â  Â  Â  Â  prompt = NATIONAL_FARMER_PROBLEM_SOLVER_PROMPT
Â  Â  Â  Â  prompt = prompt.replace("DISEASE_CLASS", disease_class)
Â  Â  Â  Â  prompt = prompt.replace("CROP_NAME", crop_name)
Â  Â  Â  Â  prompt = prompt.replace("CONFIDENCE_PERCENT", str(int(confidence * 100)))
Â  Â  Â  Â  prompt = prompt.replace("FARMER_LANG", language.lower())
Â  Â  Â  Â  prompt = prompt.replace("DISTRICT", district)
Â  Â  Â  Â  prompt = prompt.replace("STATE", state)
Â  Â  Â  Â  prompt = prompt.replace("CURRENT_SEASON", season)
Â  Â  Â  Â  prompt = prompt.replace("TODAY_DATE", datetime.now().strftime('%Y-%m-%d'))
Â  Â  Â  Â  prompt = prompt.replace("TIMESTAMP", str(int(datetime.now().timestamp())))


Â  Â  Â  Â  # Gemini API call
Â  Â  Â  Â  model = genai.GenerativeModel(
Â  Â  Â  Â  Â  Â  'gemini-2.5-flash',
Â  Â  Â  Â  Â  Â  generation_config={
Â  Â  Â  Â  Â  Â  Â  Â  'temperature': 0.3,
Â  Â  Â  Â  Â  Â  Â  Â  'max_output_tokens': 8192
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  )
Â  Â  Â  Â  response = model.generate_content(prompt)
Â  Â  Â  Â  response_text = response.text
Â  Â  Â  Â  json_start = response_text.find('{')
Â  Â  Â  Â  json_end = response_text.rfind('}') + 1
Â  Â  Â  Â  if json_start == -1 or json_end <= json_start:
Â  Â  Â  Â  Â  Â  print("âŒ No JSON in response")
Â  Â  Â  Â  Â  Â  return None
Â  Â  Â  Â  json_str = response_text[json_start:json_end]
Â  Â  Â  Â  report = json.loads(json_str)
Â  Â  Â  Â  print("âœ… Comprehensive report generated!")
Â  Â  Â  Â  return report


Â  Â  except Exception as e:
Â  Â  Â  Â  print(f"âŒ Gemini error: {e}")
Â  Â  Â  Â  import traceback
Â  Â  Â  Â  traceback.print_exc()
Â  Â  Â  Â  return None



@app.route('/health', methods=['GET'])
def health():
Â  Â  return jsonify({'status': 'healthy', 'model': 'loaded' if MODEL else 'failed'})


@app.route('/api/predict', methods=['POST', 'OPTIONS'])
def predict():
Â  Â  if request.method == 'OPTIONS':
Â  Â  Â  Â  return '', 204


Â  Â  try:
Â  Â  Â  Â  print("\nğŸ“¨ Request received")
Â  Â  Â  Â  data = request.get_json()


Â  Â  Â  Â  if not data or not data.get('image'):
Â  Â  Â  Â  Â  Â  return jsonify({'success': False, 'error': 'No image'}), 400


Â  Â  Â  Â  if not MODEL:
Â  Â  Â  Â  Â  Â  return jsonify({'success': False, 'error': 'Model not loaded'}), 500


Â  Â  Â  Â  # Decode image
Â  Â  Â  Â  print("ğŸ”„ Decoding image...")
Â  Â  Â  Â  image_data = base64.b64decode(data['image'])
Â  Â  Â  Â  img = Image.open(BytesIO(image_data)).convert('RGB')
Â  Â  Â  Â  img = img.resize((MODEL_WIDTH, MODEL_HEIGHT))
Â  Â  Â  Â  print(f"ğŸ“ Resized to: {MODEL_WIDTH}x{MODEL_HEIGHT}")


Â  Â  Â  Â  img_array = image.img_to_array(img) / 255.0
Â  Â  Â  Â  print(f"âœ… Image array shape: {img_array.shape}")
Â  Â  Â  Â  img_batch = np.expand_dims(img_array, axis=0)
Â  Â  Â  Â  print(f"âœ… Batch shape: {img_batch.shape}")


Â  Â  Â  Â  print("ğŸ¤– Running prediction...")
Â  Â  Â  Â  predictions = MODEL.predict(img_batch, verbose=0)
Â  Â  Â  Â  print(f"âœ… Predictions shape: {predictions.shape}")
Â  Â  Â  Â  print(f"âœ… Predictions: {predictions}")


Â  Â  Â  Â  prediction_probs = predictions[0] Â  # <--- KEY FIX
Â  Â  Â  Â  top_index = np.argmax(prediction_probs)
Â  Â  Â  Â  confidence = float(prediction_probs[top_index]) Â  # <--- KEY FIX
Â  Â  Â  Â  disease_name = str(DISEASE_CLASSES[top_index])


Â  Â  Â  Â  print(f"âœ… Disease: {disease_name} ({confidence*100:.1f}%)")


Â  Â  Â  Â  # ... generate report and return as before ...



Â  Â  Â  Â  # Get parameters
Â  Â  Â  Â  language = data.get('language', 'en').lower()
Â  Â  Â  Â  district = data.get('district', 'Unknown')
Â  Â  Â  Â  state = data.get('state', 'Unknown')


Â  Â  Â  Â  print(f"ğŸŒ Language: {language}, Location: {district}, {state}")


Â  Â  Â  Â  # Generate report
Â  Â  Â  Â  report = generate_gemini_report(disease_name, confidence, district, state, language)


Â  Â  Â  Â  return jsonify({
Â  Â  Â  Â  Â  Â  'success': True,
Â  Â  Â  Â  Â  Â  'disease_class': disease_name,
Â  Â  Â  Â  Â  Â  'confidence': confidence,
Â  Â  Â  Â  Â  Â  'language_generated': language,
Â  Â  Â  Â  Â  Â  'report': report
Â  Â  Â  Â  })


Â  Â  except Exception as e:
Â  Â  Â  Â  print(f"âŒ Error: {e}")
Â  Â  Â  Â  import traceback
Â  Â  Â  Â  traceback.print_exc()
Â  Â  Â  Â  return jsonify({'success': False, 'error': str(e)}), 500


# ============================================
# RUN
# ============================================


print("\n" + "="*70)
public_url = ngrok.connect(5000)
print(f"âœ… Backend URL: {public_url}")
print(f"âœ… API: {public_url}/api/predict")
print("="*70 + "\n")


app.run(debug=False, port=5000)